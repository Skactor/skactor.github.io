---
layout: post
title: "Tor: 洋葱服务协议"
date: "2018-04-11T16:52:25.853Z"
tags:
  - Tor
categories:
  - 翻译
---

Tor 可以让用户在提供各种服务的同时隐藏自己的位置，例如网络发布或即时消息服务器。使用 Tor“会合点”，其他 Tor 用户可以连接到这些洋葱服务，以前称为隐藏服务，每个服务都不知道对方的网络身份。本页面描述了这个交会协议如何工作的技术细节。有关更直接的操作方法，请参阅我们的[配置洋葱服务](https://www.torproject.org/docs/tor-onion-service.html.en)页面。

<!--more-->

洋葱服务需要在 Tor 网络上宣传其存在，然后客户才能与其联系。因此，该服务会随机挑选一些**中继**，为他们建立**线路**，并要求他们通过告诉他们**公钥**来作为**引导点**。请注意，在下面的图中，绿色链接是**线路**而不是直接连接。通过使用**完整**的 Tor 线路，任何人都很难将**引导点**与洋葱服务器的 IP 地址相关联。虽然**引导点**和其他人被告知洋葱服务的身份（公钥），但我们不希望他们了解洋葱服务器的位置（IP 地址）。

![1](./Tor-洋葱服务协议/20180411174605881.png)

第二步：洋葱服务组装一个**洋葱服务描述符（_onion service descriptor_）**，包含**其公共密钥和每个引导点的摘要**，并使用其**私钥**对该描述符进行**签名**。 它将该描述符上传到一个**分布式散列表（_distributed hash table_）**。 描述符将由客户端请求 XYZ.onion 找到，其中 XYZ 是从服务的公钥导出的 16 个字符的名称。 这一步之后，洋葱服务就建立起来了。

虽然使用自动生成的服务名称可能看起来不切实际，但它有一个重要目的：每个人——包括**引导点**，**分布式哈希表目录**，当然还有**客户端**——都可以验证他们正在与正确的洋葱服务交谈。 另请参见[Zooko 的猜想](https://en.wikipedia.org/wiki/Zooko%27s_triangle)，即从分权，安全和易记的角度出发，您最多可以实现两个。 也许有一天有人会为洋葱服务名称实施[Petname 设计](http://www.skyhunter.com/marcs/petnames/IntroPetNames.html)？

> Zooko 的三角形是三个属性的三重困境，通常被认为对于网络协议参与者的名字是可取的：
>
> 有意义的人物：向用户提供有意义且令人难忘（低熵）的名字。
>
> 安全：恶意实体可能对系统造成的损害数量应尽可能低。
>
> 分权：名称正确地解决其各自的实体，而不使用中央权威机构或服务。

![2](./Tor-洋葱服务协议/20180411174645472.png)

第三步：想要联系洋葱服务的客户需要先了解该服务的**洋葱地址（_onion address_）**。
之后，客户端可以通过从**分布式**散列表中下载**描述符**来启动连接建立。 如果 XYZ.onion 有一个描述符（即使洋葱服务已经离线或很久以前离开，或洋葱地址可能有错字），客户现在就获取了一组**引导点和正确的公钥**。 大约在这个时候，客户端还创建了一个线路到另一个随机选择的中继，并告知它一次性密钥来充当**会合点（_rendezvous point_）**。

![3](./Tor-洋葱服务协议/20180411174701272.png)

第四步：当描述符出现并且**会合点**准备好时，客户端组合一条**引入消息（_introduce message_）**（使用洋葱服务的公钥加密），包括**会合点的地址和一次性密钥**。 客户将此消息发送给其中一个引导点，请求将其发送到洋葱服务。 再次，通过 Tor 线路进行通信：没有人可以将引入消息发送到客户端的 IP 地址，因此客户端保持匿名。

![4](./Tor-洋葱服务协议/2018041117472831.png)

第五步：**洋葱服务**解密客户端的**引入信息**，并找到会合点的地址和其中的一次性密钥。 该服务为会合点创建一个线路，并将该一次性密钥发送到**集合消息**中。

在这一点上，洋葱服务在创建新线路时坚持使用同一套[**Entry Guard**](https://www.torproject.org/docs/faq#EntryGuards)是特别重要的。 否则，攻击者可以运行自己的中继器并强制洋葱服务创建任意数量的线路，从而导致**伪造中继**被选为入口节点，并通过时序分析研究洋葱服务器的 IP 地址。 Øverlier 和 Syverson 在其名为“[Locating Hidden Servers(定位隐藏服务器)](https://www.onion-router.net/Publications/locating-hidden-servers.pdf)”的论文中描述了这种攻击。

![5](./Tor-洋葱服务协议/20180411174844784.png)

在最后一步中，**会合点**通知**客户端**成功建立连接。 之后，客户端和洋葱服务可以使用他们的线路到会合点进行相互通信。 会合点只是将（客户端到终端加密的）消息从客户端中继到服务，反之亦然。

不使用引入线路进行实际通信的原因之一是，没有**任何一个中继应该对给定的洋葱服务负责**。 这就是为什么会合点永远不了解洋葱服务的身份。

一般来说，客户和洋葱服务之间的完整连接由**6 个中继**组成：其中 3 个由客户挑选，第三个为会合点，另外 3 个由洋葱服务挑选。

![6](./Tor-洋葱服务协议/20180411174911781.png)

有关洋葱服务协议的详细描述比这个更详细。 有关详细设计说明和[消息格式的集合规范](https://gitweb.torproject.org/torspec.git/tree/rend-spec.txt)，请参阅[Tor 设计文件](https://svn.torproject.org/svn/projects/design-paper/tor-design.pdf)。

原文地址： [https://www.torproject.org/docs/onion-services](https://www.torproject.org/docs/onion-services)
